#!/bin/sh
#
# Pre-commit hook to prevent committing sensitive data
# 
# To install:
#   cp .github/hooks/pre-commit.sample .git/hooks/pre-commit
#   chmod +x .git/hooks/pre-commit
#

# Colors for output
RED='\033[0;31m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

# Patterns to search for
PATTERNS=(
    "password"
    "token"
    "api_key"
    "secret"
    "private_key"
    "access_token"
    "client_secret"
    "app_secret"
    "AKIA"  # AWS Access Key
    "ghp_"  # GitHub Personal Access Token
    "sk-"   # OpenAI/Anthropic API Key
    "IGAA"  # Instagram Access Token
)

echo "üîç Checking for sensitive data..."

# Check staged files for sensitive patterns
for pattern in "${PATTERNS[@]}"; do
    matches=$(git diff --cached --name-only -z | xargs -0 git diff --cached | grep -i "$pattern" | grep -v "\.md:" | grep -v "\.example" | grep -v "# " || true)
    
    if [ -n "$matches" ]; then
        echo "${RED}‚ö†Ô∏è  WARNING: Potential secret found matching pattern: $pattern${NC}"
        echo "$matches"
        echo ""
    fi
done

# Check if .env file is being committed
if git diff --cached --name-only | grep -q "^\.env$"; then
    echo "${RED}‚ùå ERROR: .env file should not be committed!${NC}"
    echo "Use .env.example instead"
    exit 1
fi

# Check if mcp.json is being committed
if git diff --cached --name-only | grep -q "\.kiro/settings/mcp\.json$"; then
    echo "${RED}‚ùå ERROR: MCP settings with tokens should not be committed!${NC}"
    echo "Use mcp.json.example instead"
    exit 1
fi

# Check for common credential files
FORBIDDEN_FILES=(
    "credentials.json"
    "secrets.json"
    "id_rsa"
    "*.pem"
    "*.key"
)

for file_pattern in "${FORBIDDEN_FILES[@]}"; do
    if git diff --cached --name-only | grep -q "$file_pattern"; then
        echo "${RED}‚ùå ERROR: Credential file detected: $file_pattern${NC}"
        echo "This file should not be committed"
        exit 1
    fi
done

echo "‚úÖ Pre-commit checks passed"
exit 0
