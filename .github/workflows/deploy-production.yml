name: Deploy to Production VPS

on:
  push:
    branches:
      - main
  workflow_dispatch:  # Allow manual trigger

jobs:
  deploy:
    name: Deploy to Ubuntu VPS
    runs-on: ubuntu-latest

    steps:
      - name: üöÄ Deploy to VPS
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          key: ${{ secrets.VPS_SSH_KEY }}
          port: ${{ secrets.VPS_PORT || 22 }}
          script: |
            set -e

            # Disable interactive prompts for apt and service restarts
            export DEBIAN_FRONTEND=noninteractive
            export NEEDRESTART_MODE=a
            export NEEDRESTART_SUSPEND=1

            echo "======================================"
            echo "üöÄ Starting Deployment"
            echo "======================================"

            # Check if first-time deployment or update
            if [ -d "/opt/insta-messaging" ]; then
              echo "üì¶ Existing deployment detected - performing update"

              cd /opt/insta-messaging

              # Pull latest code
              echo "‚¨áÔ∏è  Pulling latest code from main..."
              sudo -u insta-messaging git fetch origin
              sudo -u insta-messaging git reset --hard origin/main

              # Update secrets in .env if they changed
              echo "üîê Updating secrets..."
              sudo bash -c "cat > /opt/insta-messaging/.env.temp << 'ENVEOF'
            # Instagram/Facebook Credentials
            FACEBOOK_VERIFY_TOKEN=${{ secrets.FACEBOOK_VERIFY_TOKEN }}
            FACEBOOK_APP_SECRET=${{ secrets.FACEBOOK_APP_SECRET }}
            INSTAGRAM_APP_SECRET=${{ secrets.INSTAGRAM_APP_SECRET }}
            INSTAGRAM_PAGE_ACCESS_TOKEN=${{ secrets.INSTAGRAM_PAGE_ACCESS_TOKEN }}
            INSTAGRAM_BUSINESS_ACCOUNT_ID=${{ secrets.INSTAGRAM_BUSINESS_ACCOUNT_ID }}

            # Server Configuration
            HOST=0.0.0.0
            PORT=8000
            ENVIRONMENT=production

            # Database Configuration
            DATABASE_URL=sqlite+aiosqlite:////opt/insta-messaging/data/production.db

            # CRM MySQL Configuration (optional)
            # Non-sensitive config is committed to repo, only password is secret
            CRM_MYSQL_ENABLED=false
            CRM_MYSQL_HOST=
            CRM_MYSQL_USER=
            CRM_MYSQL_PASSWORD=${{ secrets.CRM_MYSQL_PASSWORD }}
            CRM_MYSQL_DATABASE=

            # Logging
            LOG_LEVEL=INFO

            # Authentication - MUST be false in production
            USE_STUB_AUTH=false

            # Ngrok Configuration (REQUIRED until you have a real domain with SSL)
            # Instagram webhooks need HTTPS, ngrok provides this for test VPS
            # Remove this once you deploy to a real domain with Let's Encrypt SSL
            NGROK_AUTHTOKEN=${{ secrets.NGROK_AUTHTOKEN }}
            ENVEOF"

              # Move new .env into place
              sudo mv /opt/insta-messaging/.env.temp /opt/insta-messaging/.env
              sudo chmod 600 /opt/insta-messaging/.env
              sudo chown insta-messaging:insta-messaging /opt/insta-messaging/.env

              # Update Python dependencies
              echo "üìö Updating Python dependencies..."
              sudo -u insta-messaging /opt/insta-messaging/venv/bin/pip install -q --upgrade pip
              sudo -u insta-messaging /opt/insta-messaging/venv/bin/pip install -q -r requirements.txt

              # Run database migrations
              echo "üóÑÔ∏è  Running database migrations..."
              cd /opt/insta-messaging
              sudo -u insta-messaging /opt/insta-messaging/venv/bin/alembic upgrade head

              # Build frontend
              echo "üé® Building frontend..."
              cd /opt/insta-messaging/frontend
              sudo -u insta-messaging npm install --silent
              sudo -u insta-messaging npm run build

              # Install/configure ngrok (needed for Instagram webhooks until real domain)
              echo "üåê Configuring ngrok..."
              if ! command -v ngrok &> /dev/null; then
                echo "Installing ngrok..."
                cd /tmp
                wget -q https://bin.equinox.io/c/bNyj1mQVY4c/ngrok-v3-stable-linux-amd64.tgz
                tar xzf ngrok-v3-stable-linux-amd64.tgz
                sudo mv ngrok /usr/local/bin/
                sudo chmod +x /usr/local/bin/ngrok
                echo "‚úÖ ngrok installed"
              fi

              # Configure ngrok auth token
              if [ ! -z "${{ secrets.NGROK_AUTHTOKEN }}" ]; then
                sudo -u insta-messaging ngrok config add-authtoken ${{ secrets.NGROK_AUTHTOKEN }} --config=/opt/insta-messaging/.ngrok.yml
                echo "‚úÖ ngrok configured"
              fi

              # Restart services
              echo "üîÑ Restarting services..."
              sudo systemctl restart insta-messaging
              sudo systemctl restart nginx

              # Start/restart ngrok if configured
              if [ ! -z "${{ secrets.NGROK_AUTHTOKEN }}" ]; then
                # Kill existing ngrok processes
                sudo pkill ngrok || true
                sleep 2
                # Start ngrok in background
                sudo -u insta-messaging nohup ngrok http --config=/opt/insta-messaging/.ngrok.yml 8000 > /opt/insta-messaging/ngrok.log 2>&1 &
                sleep 3
                echo "‚úÖ ngrok started"
                # Show ngrok URL
                curl -s http://localhost:4040/api/tunnels | grep -o '"public_url":"https://[^"]*' | cut -d'"' -f4 || echo "ngrok URL will be available at http://localhost:4040"
              fi

              # Wait for service to start
              sleep 3

              # Check service status
              if systemctl is-active --quiet insta-messaging; then
                echo "‚úÖ Service is running"
                sudo systemctl status insta-messaging --no-pager -l | head -20
              else
                echo "‚ùå Service failed to start!"
                sudo journalctl -u insta-messaging -n 50 --no-pager
                exit 1
              fi

            else
              echo "üÜï First-time deployment detected"

              # Clone repository
              echo "üì• Cloning repository..."
              sudo git clone https://github.com/november1306/insta-messaging.git /opt/insta-messaging
              cd /opt/insta-messaging
              sudo git checkout main

              # Create .env file with secrets
              echo "üîê Creating .env file..."
              sudo bash -c "cat > /opt/insta-messaging/.env << 'ENVEOF'
            # Instagram/Facebook Credentials
            FACEBOOK_VERIFY_TOKEN=${{ secrets.FACEBOOK_VERIFY_TOKEN }}
            FACEBOOK_APP_SECRET=${{ secrets.FACEBOOK_APP_SECRET }}
            INSTAGRAM_APP_SECRET=${{ secrets.INSTAGRAM_APP_SECRET }}
            INSTAGRAM_PAGE_ACCESS_TOKEN=${{ secrets.INSTAGRAM_PAGE_ACCESS_TOKEN }}
            INSTAGRAM_BUSINESS_ACCOUNT_ID=${{ secrets.INSTAGRAM_BUSINESS_ACCOUNT_ID }}

            # Server Configuration
            HOST=0.0.0.0
            PORT=8000
            ENVIRONMENT=production

            # Database Configuration
            DATABASE_URL=sqlite+aiosqlite:////opt/insta-messaging/data/production.db

            # CRM MySQL Configuration (optional)
            # Non-sensitive config is committed to repo, only password is secret
            CRM_MYSQL_ENABLED=false
            CRM_MYSQL_HOST=
            CRM_MYSQL_USER=
            CRM_MYSQL_PASSWORD=${{ secrets.CRM_MYSQL_PASSWORD }}
            CRM_MYSQL_DATABASE=

            # Logging
            LOG_LEVEL=INFO

            # Authentication - MUST be false in production
            USE_STUB_AUTH=false

            # Ngrok Configuration (REQUIRED until you have a real domain with SSL)
            # Instagram webhooks need HTTPS, ngrok provides this for test VPS
            # Remove this once you deploy to a real domain with Let's Encrypt SSL
            NGROK_AUTHTOKEN=${{ secrets.NGROK_AUTHTOKEN }}
            ENVEOF"

              sudo chmod 600 /opt/insta-messaging/.env

              # Run full deployment script
              echo "üîß Running full deployment script..."
              sudo bash /opt/insta-messaging/deploy-production.sh

              # Install/configure ngrok after deployment (needed for Instagram webhooks)
              echo "üåê Configuring ngrok..."
              if ! command -v ngrok &> /dev/null; then
                echo "Installing ngrok..."
                cd /tmp
                wget -q https://bin.equinox.io/c/bNyj1mQVY4c/ngrok-v3-stable-linux-amd64.tgz
                tar xzf ngrok-v3-stable-linux-amd64.tgz
                sudo mv ngrok /usr/local/bin/
                sudo chmod +x /usr/local/bin/ngrok
                echo "‚úÖ ngrok installed"
              fi

              # Configure ngrok auth token
              if [ ! -z "${{ secrets.NGROK_AUTHTOKEN }}" ]; then
                sudo -u insta-messaging ngrok config add-authtoken ${{ secrets.NGROK_AUTHTOKEN }} --config=/opt/insta-messaging/.ngrok.yml
                echo "‚úÖ ngrok configured"
                # Start ngrok in background
                sudo -u insta-messaging nohup ngrok http --config=/opt/insta-messaging/.ngrok.yml 8000 > /opt/insta-messaging/ngrok.log 2>&1 &
                sleep 3
                echo "‚úÖ ngrok started"
                # Show ngrok URL
                curl -s http://localhost:4040/api/tunnels | grep -o '"public_url":"https://[^"]*' | cut -d'"' -f4 || echo "ngrok URL will be available at http://localhost:4040"
              fi
            fi

            echo ""
            echo "======================================"
            echo "‚úÖ Deployment Complete!"
            echo "======================================"
            echo ""
            echo "Service Status:"
            sudo systemctl status insta-messaging --no-pager | head -10
            echo ""
            echo "Health Check:"
            curl -s http://localhost:8000/health || echo "Health check failed (may need to wait a moment)"
            echo ""
            echo "Nginx Status:"
            sudo systemctl status nginx --no-pager | head -5
            echo ""
            echo "üìç Access URLs:"
            echo "  - Direct IP: http://${{ secrets.VPS_HOST }}:8000"
            if [ ! -z "${{ secrets.NGROK_AUTHTOKEN }}" ]; then
              echo "  - ngrok HTTPS (for Instagram): Check http://localhost:4040 or logs above"
              NGROK_URL=$(curl -s http://localhost:4040/api/tunnels | grep -o '"public_url":"https://[^"]*' | head -1 | cut -d'"' -f4)
              if [ ! -z "$NGROK_URL" ]; then
                echo "  - ngrok URL: $NGROK_URL"
                echo ""
                echo "‚ö†Ô∏è  IMPORTANT: Use this ngrok URL for Instagram webhook configuration:"
                echo "     $NGROK_URL/webhooks/instagram"
              fi
            fi

      - name: üîî Deployment Success
        if: success()
        run: |
          echo "‚úÖ Deployment to ${{ secrets.VPS_HOST }} completed successfully!"
          echo "üåê App URL: https://${{ secrets.VPS_HOST }}"
          echo "üìä API Docs: https://${{ secrets.VPS_HOST }}/docs"
          echo "üí¨ Frontend: https://${{ secrets.VPS_HOST }}/chat"

      - name: ‚ùå Deployment Failed
        if: failure()
        run: |
          echo "::error::Deployment failed! Check the logs above for details."
          echo "Common issues:"
          echo "  - SSH connection failed (check VPS_HOST, VPS_USER, VPS_SSH_KEY)"
          echo "  - Missing GitHub Secrets (check repository settings)"
          echo "  - Service failed to start (check systemd logs)"
