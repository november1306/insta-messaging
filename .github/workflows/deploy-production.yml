name: Deploy to Production VPS

on:
  push:
    branches:
      - main  # Auto-deploy on push to main
  workflow_dispatch:  # Also allow manual trigger

jobs:
  deploy:
    name: Deploy to Ubuntu VPS
    runs-on: ubuntu-latest

    steps:
      - name: üöÄ Deploy to VPS
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          key: ${{ secrets.VPS_SSH_KEY }}
          port: ${{ secrets.VPS_PORT || 22 }}
          script: |
            set -e

            # Disable interactive prompts for apt and service restarts
            export DEBIAN_FRONTEND=noninteractive
            export NEEDRESTART_MODE=a
            export NEEDRESTART_SUSPEND=1

            echo "======================================"
            echo "üöÄ Starting Deployment"
            echo "======================================"

            # Check if first-time deployment or update
            if [ -d "/opt/insta-messaging" ]; then
              echo "üì¶ Existing deployment detected - performing update"

              cd /opt/insta-messaging

              # Pull latest code
              echo "‚¨áÔ∏è  Pulling latest code from main..."
              sudo -u insta-messaging git fetch origin
              sudo -u insta-messaging git reset --hard origin/main

              # Update secrets in .env if they changed
              echo "üîê Updating secrets..."
              sudo bash -c "cat > /opt/insta-messaging/.env.temp << 'ENVEOF'
            # Instagram/Facebook Credentials
            FACEBOOK_VERIFY_TOKEN=${{ secrets.FACEBOOK_VERIFY_TOKEN }}
            FACEBOOK_APP_SECRET=${{ secrets.FACEBOOK_APP_SECRET }}
            INSTAGRAM_APP_SECRET=${{ secrets.INSTAGRAM_APP_SECRET }}
            # Legacy credentials removed - OAuth system uses per-account tokens in database

            # Instagram OAuth Configuration (Multi-Account Support)
            INSTAGRAM_OAUTH_CLIENT_ID=${{ secrets.INSTAGRAM_OAUTH_CLIENT_ID }}
            INSTAGRAM_OAUTH_CLIENT_SECRET=${{ secrets.INSTAGRAM_OAUTH_CLIENT_SECRET }}
            INSTAGRAM_OAUTH_REDIRECT_URI=${{ secrets.INSTAGRAM_OAUTH_REDIRECT_URI }}

            # Server Configuration
            HOST=0.0.0.0
            PORT=8000
            ENVIRONMENT=production

            # Database Configuration
            DATABASE_URL=sqlite+aiosqlite:////opt/insta-messaging/data/production.db

            # Public Base URL (required for outbound media attachments and OAuth redirects)
            # Frontend URL is derived automatically: PUBLIC_BASE_URL + "/chat/"
            PUBLIC_BASE_URL=${{ secrets.PUBLIC_BASE_URL || 'http://185.156.43.172' }}

            # CRM MySQL Configuration (optional)
            CRM_MYSQL_ENABLED=${{ secrets.CRM_MYSQL_ENABLED || 'false' }}
            CRM_MYSQL_HOST=${{ secrets.CRM_MYSQL_HOST || '' }}
            CRM_MYSQL_USER=${{ secrets.CRM_MYSQL_USER || '' }}
            CRM_MYSQL_PASSWORD=${{ secrets.CRM_MYSQL_PASSWORD || '' }}
            CRM_MYSQL_DATABASE=${{ secrets.CRM_MYSQL_DATABASE || '' }}

            # Logging
            LOG_LEVEL=INFO

            # JWT/Session Configuration
            SESSION_SECRET=${{ secrets.SESSION_SECRET }}
            JWT_ALGORITHM=HS256
            JWT_EXPIRATION_HOURS=24

            # Ngrok Configuration (REQUIRED until you have a real domain with SSL)
            # Instagram webhooks need HTTPS, ngrok provides this for test VPS
            # Remove this once you deploy to a real domain with Let's Encrypt SSL
            NGROK_AUTHTOKEN=${{ secrets.NGROK_AUTHTOKEN }}
            ENVEOF"

              # Move new .env into place
              sudo mv /opt/insta-messaging/.env.temp /opt/insta-messaging/.env
              sudo chmod 600 /opt/insta-messaging/.env
              sudo chown insta-messaging:insta-messaging /opt/insta-messaging/.env

              # Check if venv exists and uses correct Python version
              echo "üêç Checking Python virtual environment..."
              if [ ! -f "/opt/insta-messaging/venv/bin/python" ]; then
                echo "Virtual environment not found, creating with Python 3.12..."
                sudo -u insta-messaging python3.12 -m venv /opt/insta-messaging/venv
              else
                # Check venv Python version
                VENV_PYTHON_VERSION=$(/opt/insta-messaging/venv/bin/python --version 2>&1 | awk '{print $2}')
                VENV_MAJOR=$(echo $VENV_PYTHON_VERSION | cut -d. -f1)
                VENV_MINOR=$(echo $VENV_PYTHON_VERSION | cut -d. -f2)

                if [ "$VENV_MAJOR" -lt 3 ] || ([ "$VENV_MAJOR" -eq 3 ] && [ "$VENV_MINOR" -lt 12 ]); then
                  echo "Virtual environment uses old Python $VENV_PYTHON_VERSION, recreating with Python 3.12..."
                  sudo rm -rf /opt/insta-messaging/venv
                  sudo -u insta-messaging python3.12 -m venv /opt/insta-messaging/venv
                else
                  echo "Virtual environment OK (Python $VENV_PYTHON_VERSION)"
                fi
              fi

              # Install Node.js if not present
              echo "üì¶ Checking Node.js..."
              if ! command -v node &> /dev/null; then
                echo "Installing Node.js from NodeSource repository..."
                curl -fsSL https://deb.nodesource.com/setup_20.x | sudo -E bash -
                sudo DEBIAN_FRONTEND=noninteractive apt-get install -y -qq nodejs
                echo "Node.js $(node --version) installed"
                echo "npm $(npm --version) installed"
              else
                echo "Node.js already installed: $(node --version)"
                echo "npm version: $(npm --version)"
              fi

              # Update Python dependencies
              echo "üìö Updating Python dependencies..."
              sudo -u insta-messaging /opt/insta-messaging/venv/bin/pip install -q --upgrade pip
              sudo -u insta-messaging /opt/insta-messaging/venv/bin/pip install -q -r requirements.txt

              # Create data directory for SQLite database
              echo "üìÅ Ensuring data directory exists..."
              sudo mkdir -p /opt/insta-messaging/data
              sudo chown insta-messaging:insta-messaging /opt/insta-messaging/data
              sudo chmod 755 /opt/insta-messaging/data

              # Run database migrations
              echo "üóÑÔ∏è  Running database migrations..."
              cd /opt/insta-messaging
              sudo -u insta-messaging /opt/insta-messaging/venv/bin/alembic upgrade head

              # Build frontend
              echo "üé® Building frontend..."
              cd /opt/insta-messaging/frontend

              # Fix permissions on dist directory if it exists (may be owned by root from previous builds)
              if [ -d "dist" ]; then
                sudo chown -R insta-messaging:insta-messaging dist
                echo "Fixed dist directory permissions"
              fi

              sudo -u insta-messaging npm install --silent

              # Build frontend
              echo "Building frontend..."
              sudo -u insta-messaging bash -c 'cd /opt/insta-messaging/frontend && npm run build'

              # Update nginx configuration using dedicated script
              echo "üîß Updating nginx configuration..."
              sudo chmod +x /opt/insta-messaging/scripts/linux/configure-nginx.sh
              DOMAIN_NAME="${{ secrets.DOMAIN_NAME }}"
              if [ -z "$DOMAIN_NAME" ]; then
                DOMAIN_NAME="_"
              fi
              sudo bash /opt/insta-messaging/scripts/linux/configure-nginx.sh insta-messaging /opt/insta-messaging "$DOMAIN_NAME"

              # Configure SSL with Let's Encrypt if domain is set
              if [ "$DOMAIN_NAME" != "_" ]; then
                echo "üîí Configuring SSL for $DOMAIN_NAME..."

                # Validate DNS points to this VPS before attempting SSL
                VPS_IP=$(curl -s ifconfig.me)
                DOMAIN_IP=$(dig +short "$DOMAIN_NAME" A | head -1)

                if [ -z "$DOMAIN_IP" ]; then
                  echo "‚ö†Ô∏è DNS not configured: $DOMAIN_NAME has no A record"
                  echo "   Skipping SSL setup - configure DNS and run certbot manually"
                elif [ "$DOMAIN_IP" != "$VPS_IP" ]; then
                  echo "‚ö†Ô∏è DNS mismatch: $DOMAIN_NAME ‚Üí $DOMAIN_IP (expected $VPS_IP)"
                  echo "   Skipping SSL setup - fix DNS or wait for propagation"
                else
                  echo "‚úÖ DNS validated: $DOMAIN_NAME ‚Üí $VPS_IP"

                  # Install certbot if not present
                  if ! command -v certbot &> /dev/null; then
                    echo "Installing certbot..."
                    apt-get update -qq
                    apt-get install -y -qq certbot python3-certbot-nginx
                  fi

                  # Check if certificate already exists
                  if [ -f "/etc/letsencrypt/live/$DOMAIN_NAME/fullchain.pem" ]; then
                    echo "‚úÖ SSL certificate already exists for $DOMAIN_NAME"
                  else
                    echo "Obtaining SSL certificate..."
                    certbot --nginx -d "$DOMAIN_NAME" --non-interactive --agree-tos --register-unsafely-without-email || echo "‚ö†Ô∏è SSL setup failed - continuing without SSL"
                  fi
                fi
              fi

              # Install/configure ngrok (needed for Instagram webhooks until real domain)
              echo "üåê Configuring ngrok..."
              if ! command -v ngrok &> /dev/null; then
                echo "Installing ngrok..."
                cd /tmp
                wget -q https://bin.equinox.io/c/bNyj1mQVY4c/ngrok-v3-stable-linux-amd64.tgz
                tar xzf ngrok-v3-stable-linux-amd64.tgz
                sudo mv ngrok /usr/local/bin/
                sudo chmod +x /usr/local/bin/ngrok
                echo "‚úÖ ngrok installed"
              fi

              # Configure ngrok auth token
              if [ ! -z "${{ secrets.NGROK_AUTHTOKEN }}" ]; then
                sudo -u insta-messaging ngrok config add-authtoken ${{ secrets.NGROK_AUTHTOKEN }} --config=/opt/insta-messaging/.ngrok.yml
                echo "‚úÖ ngrok configured"
              fi

              # Restart services
              echo "üîÑ Restarting services..."
              sudo systemctl restart insta-messaging
              sudo systemctl restart nginx

              # Start/restart ngrok if configured
              if [ ! -z "${{ secrets.NGROK_AUTHTOKEN }}" ]; then
                # Kill existing ngrok processes
                sudo pkill ngrok || true
                sleep 2
                # Start ngrok in background
                sudo -u insta-messaging nohup ngrok http --config=/opt/insta-messaging/.ngrok.yml 8000 > /opt/insta-messaging/ngrok.log 2>&1 &
                sleep 3
                echo "‚úÖ ngrok started"
                # Show ngrok URL
                curl -s http://localhost:4040/api/tunnels | grep -o '"public_url":"https://[^"]*' | cut -d'"' -f4 || echo "ngrok URL will be available at http://localhost:4040"
              fi

              # Wait for service to start
              sleep 3

              # Check service status
              if systemctl is-active --quiet insta-messaging; then
                echo "‚úÖ Service is running"
                sudo systemctl status insta-messaging --no-pager -l | head -20
              else
                echo "‚ùå Service failed to start!"
                sudo journalctl -u insta-messaging -n 50 --no-pager
                exit 1
              fi

            else
              echo "üÜï First-time deployment detected"

              # Clone repository
              echo "üì• Cloning repository..."
              sudo git clone https://github.com/november1306/insta-messaging.git /opt/insta-messaging
              cd /opt/insta-messaging
              sudo git checkout main

              # Fix git ownership for future operations
              sudo git config --global --add safe.directory /opt/insta-messaging

              # Create .env file with secrets
              echo "üîê Creating .env file..."
              sudo bash -c "cat > /opt/insta-messaging/.env << 'ENVEOF'
            # Instagram/Facebook Credentials
            FACEBOOK_VERIFY_TOKEN=${{ secrets.FACEBOOK_VERIFY_TOKEN }}
            FACEBOOK_APP_SECRET=${{ secrets.FACEBOOK_APP_SECRET }}
            INSTAGRAM_APP_SECRET=${{ secrets.INSTAGRAM_APP_SECRET }}
            # Legacy credentials removed - OAuth system uses per-account tokens in database

            # Instagram OAuth Configuration (Multi-Account Support)
            INSTAGRAM_OAUTH_CLIENT_ID=${{ secrets.INSTAGRAM_OAUTH_CLIENT_ID }}
            INSTAGRAM_OAUTH_CLIENT_SECRET=${{ secrets.INSTAGRAM_OAUTH_CLIENT_SECRET }}
            INSTAGRAM_OAUTH_REDIRECT_URI=${{ secrets.INSTAGRAM_OAUTH_REDIRECT_URI }}

            # Server Configuration
            HOST=0.0.0.0
            PORT=8000
            ENVIRONMENT=production

            # Database Configuration
            DATABASE_URL=sqlite+aiosqlite:////opt/insta-messaging/data/production.db

            # Public Base URL (required for outbound media attachments and OAuth redirects)
            # Frontend URL is derived automatically: PUBLIC_BASE_URL + "/chat/"
            PUBLIC_BASE_URL=${{ secrets.PUBLIC_BASE_URL || 'http://185.156.43.172' }}

            # CRM MySQL Configuration (optional)
            CRM_MYSQL_ENABLED=${{ secrets.CRM_MYSQL_ENABLED || 'false' }}
            CRM_MYSQL_HOST=${{ secrets.CRM_MYSQL_HOST || '' }}
            CRM_MYSQL_USER=${{ secrets.CRM_MYSQL_USER || '' }}
            CRM_MYSQL_PASSWORD=${{ secrets.CRM_MYSQL_PASSWORD || '' }}
            CRM_MYSQL_DATABASE=${{ secrets.CRM_MYSQL_DATABASE || '' }}

            # Logging
            LOG_LEVEL=INFO

            # JWT/Session Configuration
            SESSION_SECRET=${{ secrets.SESSION_SECRET }}
            JWT_ALGORITHM=HS256
            JWT_EXPIRATION_HOURS=24

            # Ngrok Configuration (REQUIRED until you have a real domain with SSL)
            # Instagram webhooks need HTTPS, ngrok provides this for test VPS
            # Remove this once you deploy to a real domain with Let's Encrypt SSL
            NGROK_AUTHTOKEN=${{ secrets.NGROK_AUTHTOKEN }}
            ENVEOF"

              sudo chmod 600 /opt/insta-messaging/.env

              # Run full VPS provisioning script with admin password and domain
              echo "üîß Running VPS provisioning script (first-time setup)..."
              export ADMIN_PASSWORD="${{ secrets.ADMIN_PASSWORD }}"
              export DOMAIN_NAME="${{ secrets.DOMAIN_NAME }}"
              sudo -E bash /opt/insta-messaging/scripts/linux/provision-vps.sh

              # Install/configure ngrok after deployment (needed for Instagram webhooks)
              echo "üåê Configuring ngrok..."
              if ! command -v ngrok &> /dev/null; then
                echo "Installing ngrok..."
                cd /tmp
                wget -q https://bin.equinox.io/c/bNyj1mQVY4c/ngrok-v3-stable-linux-amd64.tgz
                tar xzf ngrok-v3-stable-linux-amd64.tgz
                sudo mv ngrok /usr/local/bin/
                sudo chmod +x /usr/local/bin/ngrok
                echo "‚úÖ ngrok installed"
              fi

              # Configure ngrok auth token
              if [ ! -z "${{ secrets.NGROK_AUTHTOKEN }}" ]; then
                sudo -u insta-messaging ngrok config add-authtoken ${{ secrets.NGROK_AUTHTOKEN }} --config=/opt/insta-messaging/.ngrok.yml
                echo "‚úÖ ngrok configured"
                # Start ngrok in background
                sudo -u insta-messaging nohup ngrok http --config=/opt/insta-messaging/.ngrok.yml 8000 > /opt/insta-messaging/ngrok.log 2>&1 &
                sleep 3
                echo "‚úÖ ngrok started"
                # Show ngrok URL
                curl -s http://localhost:4040/api/tunnels | grep -o '"public_url":"https://[^"]*' | cut -d'"' -f4 || echo "ngrok URL will be available at http://localhost:4040"
              fi
            fi

            echo ""
            echo "======================================"
            echo "‚úÖ Deployment Complete!"
            echo "======================================"
            echo ""
            echo "Service Status:"
            sudo systemctl status insta-messaging --no-pager | head -10
            echo ""
            echo "Health Check:"
            curl -s http://localhost:8000/health || echo "Health check failed (may need to wait a moment)"
            echo ""
            echo "Nginx Status:"
            sudo systemctl status nginx --no-pager | head -5
            echo ""
            echo "üìç Access URLs:"
            echo "  - Direct IP: http://${{ secrets.VPS_HOST }}:8000"
            if [ ! -z "${{ secrets.NGROK_AUTHTOKEN }}" ]; then
              echo "  - ngrok HTTPS (for Instagram): Check http://localhost:4040 or logs above"
              NGROK_URL=$(curl -s http://localhost:4040/api/tunnels | grep -o '"public_url":"https://[^"]*' | head -1 | cut -d'"' -f4)
              if [ ! -z "$NGROK_URL" ]; then
                echo "  - ngrok URL: $NGROK_URL"
                echo ""
                echo "‚ö†Ô∏è  IMPORTANT: Use this ngrok URL for Instagram webhook configuration:"
                echo "     $NGROK_URL/webhooks/instagram"
              fi
            fi

      - name: üîî Deployment Success
        if: success()
        run: |
          echo "‚úÖ Deployment to ${{ secrets.VPS_HOST }} completed successfully!"
          echo "üåê App URL: https://${{ secrets.VPS_HOST }}"
          echo "üìä API Docs: https://${{ secrets.VPS_HOST }}/docs"
          echo "üí¨ Frontend: https://${{ secrets.VPS_HOST }}/chat"

      - name: ‚ùå Deployment Failed
        if: failure()
        run: |
          echo "::error::Deployment failed! Check the logs above for details."
          echo "Common issues:"
          echo "  - SSH connection failed (check VPS_HOST, VPS_USER, VPS_SSH_KEY)"
          echo "  - Missing GitHub Secrets (check repository settings)"
          echo "  - Service failed to start (check systemd logs)"
